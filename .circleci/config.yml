version: 2

jobs:

  build:
    docker:
      - image: circleci/python:2.7
      - image: mongo:3.6

    working_directory: /home/circleci/project # as $CIRCLE_WORKING_DIRECTORY

    environment:
      - GIRDER_VERSION: baccb4e11056a59eead9658f2078ae68867237d3

    steps:
      - run:
          name: Install Node.js
          command: |
            curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g npm
      - run:
          name: Install Girder dependencies
          command: sudo apt-get install -y cmake

      - run:
          name: Clone Girder
          #command: git clone --depth 1 --branch $GIRDER_VERSION -- https://github.com/girder/girder.git girder
          command: |
            git clone https://github.com/girder/girder.git girder
            git -C girder checkout $GIRDER_VERSION

      - run:
          name: Create and activate virtualenv
          command: |
            virtualenv venv
            echo "source $CIRCLE_WORKING_DIRECTORY/venv/bin/activate" >> $BASH_ENV

      - run:
          name: Install Girder
          command: |
            pip install -e .
            pip install -r ./requirements-dev.txt
          # pytest_girder requires that install be run from this directory
          working_directory: girder

      - checkout:
          path: girder/plugins/slicer_extension_manager

      - run:
          name: Install slicer_extension_manager
          command: girder-install plugin girder/plugins/slicer_extension_manager

      - restore_cache:
          key: npm-{{ arch }}-{{ checksum "girder/package.json" }}-{{ checksum "girder/plugins/slicer_extension_manager/plugin.json" }}

      - run:
          name: Build Girder web client
          command: girder-install web --dev --plugins=slicer_extension_manager
          environment:
            - npm_config_cache: /home/circleci/project/npm_cache
      - save_cache:
          paths: npm_cache
          key: npm-{{ arch }}-{{ checksum "girder/package.json" }}-{{ checksum "girder/plugins/slicer_extension_manager/plugin.json" }}

      - run:
          name: Create Girder build directory
          command: mkdir girder_build
      - run:
          name: Run CMake
          command: |
            cmake -DPYTHON_COVERAGE:BOOL=ON -DCOVERAGE_MINIMUM_PASS:STRING=40 -DPYTHON_VERSION:STRING=2.7 -DRUN_CORE_TESTS:BOOL=OFF -DTEST_PLUGINS:STRING="slicer_extension_manager" $CIRCLE_WORKING_DIRECTORY/girder
            make
          working_directory: girder_build

      - run:
          name: Run CTest
          command: ctest -V -R slicer_extension_manager
          working_directory: girder_build
